rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Collection: fuelCards
    match /fuelCards/{cardId} {
      // קריאה - רק משתמשים מחוברים (Firebase Authentication)
      allow read: if request.auth != null;
      
      // כתיבה - רק משתמשים מחוברים + ולידציה מחמירה של הנתונים
      allow create: if 
        // חובה: משתמש מחובר
        request.auth != null &&
        // בדיקה שיש את כל השדות החובה
        request.resource.data.keys().hasAll(['cardNumber', 'name', 'phone', 'amount', 'fuelType', 'gadudNumber']) &&
        // בדיקה שסוגי הנתונים נכונים
        request.resource.data.cardNumber is int &&
        request.resource.data.name is string &&
        request.resource.data.phone is string &&
        request.resource.data.amount is int &&
        request.resource.data.fuelType is string &&
        request.resource.data.gadudNumber is string &&
        // בדיקת אורך מקסימלי (הגנה מפני התקפות)
        request.resource.data.name.size() <= 100 &&
        request.resource.data.phone.size() <= 20 &&
        request.resource.data.fuelType.size() <= 50 &&
        request.resource.data.gadudNumber.size() <= 20 &&
        // בדיקה שהערכים חיוביים
        request.resource.data.amount > 0 &&
        request.resource.data.amount <= 100000 && // הגבלה מקסימלית נדיבה
        request.resource.data.cardNumber > 0 &&
        request.resource.data.cardNumber <= 999999999999; // תקרת מספר כרטיס גבוהה למניעת חסימה
      
      // עדכון - רק משתמשים מחוברים + ולידציה מחמירה
      allow update: if 
        // חובה: משתמש מחובר
        request.auth != null &&
        // בדיקה שהשדות החובה קיימים
        request.resource.data.keys().hasAll(['cardNumber', 'name', 'phone', 'amount', 'fuelType', 'gadudNumber']) &&
        // בדיקה שסוגי הנתונים נכונים
        request.resource.data.cardNumber is int &&
        request.resource.data.name is string &&
        request.resource.data.phone is string &&
        request.resource.data.amount is int &&
        request.resource.data.fuelType is string &&
        request.resource.data.gadudNumber is string &&
        // בדיקת אורך מקסימלי
        request.resource.data.name.size() <= 100 &&
        request.resource.data.phone.size() <= 20 &&
        request.resource.data.fuelType.size() <= 50 &&
        request.resource.data.gadudNumber.size() <= 20 &&
        // בדיקה שהערכים חיוביים
        request.resource.data.amount > 0 &&
        request.resource.data.amount <= 100000 && // הגבלה מקסימלית נדיבה
        request.resource.data.cardNumber > 0 &&
        request.resource.data.cardNumber <= 999999999999 && // תקרת מספר כרטיס גבוהה למניעת חסימה
        // בדיקה שמספר הכרטיס לא משתנה (אבטחה)
        request.resource.data.cardNumber == resource.data.cardNumber;
      
      // מחיקה - רק משתמשים מחוברים
      allow delete: if request.auth != null;
    }
    
    // Collection אחרות - חסום לחלוטין
    match /{document=**} {
      allow read, write: if false;
    }
  }
}




